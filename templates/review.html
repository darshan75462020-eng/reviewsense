<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Reviews</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at 60% 40%, #232526 0%, #414345 60%, #232526 100%);
      color: #f3f4f6;
      padding: 40px 20px;
      min-height: 100vh;
    }
    h2 {
      text-align: center;
      color: #fff;
      margin-bottom: 30px;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    /* Forms */
    form textarea, form input[type="file"] {
      border-radius: 14px;
      padding: 14px 16px;
      border: 1.5px solid #444;
      background: #232526;
      color: #fff;
      width: 100%;
      margin-bottom: 15px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      transition: border 0.2s, box-shadow 0.2s;
    }
    form textarea:focus, form input[type="file"]:focus {
      border: 1.5px solid #ff512f;
      box-shadow: 0 2px 8px rgba(255,81,47,0.18);
      outline: none;
    }
    form button {
      border-radius: 14px;
      padding: 12px 20px;
      cursor: pointer;
      transition: 0.3s;
      border: none;
      font-weight: 600;
    }
    .btn-submit {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
      color: #fff;
      box-shadow: 0 2px 12px rgba(34,197,94,0.2);
    }
    .btn-submit:hover {
      background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(34,197,94,0.3);
    }
    .btn-upload {
      background: linear-gradient(90deg, #1d4ed8 0%, #2563eb 100%);
      color: #fff;
      box-shadow: 0 2px 12px rgba(29,78,216,0.2);
    }
    .btn-upload:hover {
      background: linear-gradient(90deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(29,78,216,0.3);
    }

    /* Reviews List */
    #submittedReviews {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 30px;
      padding-right: 5px;
    }
    .review-card {
      background: rgba(30, 32, 34, 0.95);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      margin-bottom: 20px;
      backdrop-filter: blur(4px);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .review-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    }

    .sentiment-badge {
      padding: 6px 14px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
      margin-top: 8px;
    }
    .positive { background: #22c55e; color: #fff; }
    .negative { background: #ef4444; color: #fff; }
    .neutral  { background: #f59e0b; color: #fff; }

    /* Highlighted aspects */
    .highlight-positive { background: rgba(34,197,94,0.25); padding:2px 6px; border-radius:6px; }
    .highlight-negative { background: rgba(239,68,68,0.25); padding:2px 6px; border-radius:6px; }
    .highlight-neutral  { background: rgba(245,158,11,0.25); padding:2px 6px; border-radius:6px; }

    /* Chart */
    #chartContainer {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: rgba(30, 32, 34, 0.95);
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      backdrop-filter: blur(4px);
    }

    /* Back Button */
    .btn-back {
      display: block;
      width: 200px;
      text-align: center;
      margin: 40px auto 0;
      background: linear-gradient(90deg, #64748b 0%, #475569 100%);
      color: #fff;
      text-decoration: none;
      padding: 12px 0;
      border-radius: 14px;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(100,116,139,0.25);
      transition: 0.3s;
    }
    .btn-back:hover {
      background: linear-gradient(90deg, #475569 0%, #64748b 100%);
      transform: translateY(-2px);
    }

    /* Flash Messages */
    .alert {
      border-radius: 14px;
      border: none;
      margin-bottom: 20px;
    }
    .alert-success {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
      color: white;
    }
    .alert-danger {
      background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    .alert-info {
      background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Your Reviews</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Typed Review Form -->
    <form method="POST" action="{{ url_for('review') }}">
      <textarea name="content" id="content" rows="3" placeholder="Type your review here..." required></textarea>
      <button type="submit" class="btn btn-submit">Submit Review</button>
    </form>

    <hr class="text-light">

    <!-- Upload CSV/Text/JSON -->
    <form method="POST" enctype="multipart/form-data" action="{{ url_for('review') }}">
      <div class="mb-3">
        <label for="file" class="form-label text-light">Upload Dataset File:</label>
        <input type="file" name="file" id="file" class="form-control" accept=".csv,.txt,.json" required>
        <div class="form-text text-light">
          <strong>Supported formats:</strong><br>
          • CSV: One review per row (first column)<br>
          • TXT: One review per line<br>
          • JSON: Array of reviews or {"reviews": [...]}
        </div>
      </div>
      <button type="submit" class="btn btn-upload">Upload & Analyze Dataset</button>
    </form>

   <!-- Submitted Reviews -->
<div id="submittedReviews">
  {% if reviews %}
    {% for review in reviews %}
      <div class="review-card">
        <p><strong>Raw Review:</strong> {{ review.content }}</p>
        <p><strong>Processed Review:</strong> {{ review.highlighted_content | safe }}</p>
        <p><strong>Sentiment:</strong>
          <span class="sentiment-badge {{ review.sentiment }}">
            {{ review.sentiment | capitalize }} ({{ "%.2f"|format(review.confidence) }}%)
          </span>
        </p>
        <p><strong>Submitted:</strong> {{ review.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if review.aspect_sentiments and review.aspect_sentiments.get('aspects') %}
          <p><strong>Aspects Found:</strong>
            {% for aspect, sentiment in review.aspect_sentiments.get('aspects', {}).items() %}
              <span class="highlight-{{ sentiment }}">{{ aspect }}</span>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </p>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p style="text-align:center; color:#9ca3af; margin-top:30px;">No reviews submitted yet. Start by typing a review above or uploading a dataset file.</p>
  {% endif %}
</div>

    <!-- Chart -->
    <div id="chartContainer">
      <canvas id="userSentimentChart"></canvas>
    </div>

    <!-- Back to Dashboard Button -->
    <a href="{{ url_for('dashboard') }}" class="btn-back">⬅ Back to Dashboard</a>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sentimentData = {{ {
        "pos": positive|default(0),
        "neg": negative|default(0),
        "neu": neutral|default(0)
      }|tojson|safe }};

      const ctx = document.getElementById('userSentimentChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Positive', 'Negative', 'Neutral'],
          datasets: [{
            label: 'Reviews Sentiment',
            data: [sentimentData.pos, sentimentData.neg, sentimentData.neu],
            backgroundColor: ['#22c55e', '#ef4444', '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true, labels: { color: "#f3f4f6" } },
            title: { display: true, text: 'Overall Sentiment Distribution', color: "#fff", font: { size: 16 } },
            datalabels: {
              color: '#fff',
              formatter: (value, ctx) => {
                let sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                return sum ? (value * 100 / sum).toFixed(1) + "%" : "0%";
              }
            }
          },
          scales: {
            x: { ticks: { color: "#f3f4f6" } },
            y: { beginAtZero: true, ticks: { precision: 0, color: "#f3f4f6" } }
          }
        },
        plugins: [ChartDataLabels]
      });
    });
  </script>
</body>
</html>